<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>EduPro LMS | Portal Pembelajaran</title>

    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Plus+Jakarta+Sans:wght@300;400;500;600;700;800&display=swap" rel="stylesheet">
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.2/css/all.min.css">
    <link href="https://cdn.jsdelivr.net/npm/sweetalert2@11.7.32/dist/sweetalert2.min.css" rel="stylesheet">

    <style>
        :root { --primary-color: #4f46e5; --primary-hover: #4338ca; --bg-color: #f8fafc; --text-main: #0f172a; --text-muted: #64748b; }
        body { font-family: 'Plus Jakarta Sans', sans-serif; background-color: var(--bg-color); color: var(--text-main); min-height: 100vh; display: flex; flex-direction: column; }
        .card { border: none; border-radius: 1rem; box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.05), 0 2px 4px -1px rgba(0, 0, 0, 0.03); transition: transform 0.2s ease, box-shadow 0.2s ease; position: relative;}
        .card-hover:hover { transform: translateY(-5px); box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.1), 0 4px 6px -2px rgba(0, 0, 0, 0.05); }
        .btn { font-weight: 600; border-radius: 0.75rem; padding: 0.6rem 1.2rem; }
        .btn-primary { background-color: var(--primary-color); border-color: var(--primary-color); }
        .btn-primary:hover { background-color: var(--primary-hover); border-color: var(--primary-hover); }
        .form-control { border-radius: 0.75rem; padding: 0.75rem 1rem; border-color: #e2e8f0; }
        .form-control:focus { border-color: var(--primary-color); box-shadow: 0 0 0 0.25rem rgba(79, 70, 229, 0.25); }
        .navbar { background-color: #ffffff; box-shadow: 0 1px 3px 0 rgba(0, 0, 0, 0.1); padding: 1rem 0; }
        .navbar-brand { font-weight: 800; color: var(--primary-color) !important; font-size: 1.5rem; }
        .nav-tabs .nav-link { border: none; color: var(--text-muted); font-weight: 600; padding: 1rem 1.5rem; border-bottom: 3px solid transparent; }
        .nav-tabs .nav-link.active { color: var(--primary-color); background: transparent; border-bottom: 3px solid var(--primary-color); }
        .loader-container { display: flex; justify-content: center; align-items: center; padding: 3rem; }
        .swal2-html-container { text-align: left !important; }
        .price-badge { position: absolute; top: 1rem; right: 1rem; font-size: 0.85rem; font-weight: 700; padding: 0.5rem 0.8rem; border-radius: 2rem; box-shadow: 0 2px 4px rgba(0,0,0,0.1); z-index: 2;}
        .qris-box { border: 2px dashed #4f46e5; border-radius: 1rem; padding: 1rem; background: #fff; display: inline-block; margin-bottom: 1rem;}
        
        .progress { height: 0.75rem; border-radius: 1rem; background-color: #e2e8f0; }
        .progress-bar.bg-success { background-color: #10b981 !important; }
        iframe { border-radius: 0.5rem; border: none; width: 100%; }
        
        .certificate-btn { animation: pulse 2s infinite; }
        @keyframes pulse { 0% { box-shadow: 0 0 0 0 rgba(16, 185, 129, 0.4); } 70% { box-shadow: 0 0 0 10px rgba(16, 185, 129, 0); } 100% { box-shadow: 0 0 0 0 rgba(16, 185, 129, 0); } }
    </style>
</head>
<body>
    <div id="app"></div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11.7.32/dist/sweetalert2.all.min.js"></script>

    <script>
        // PASTIKAN ANDA MENGGANTI URL INI DENGAN HASIL DEPLOY "NEW VERSION" ANDA
        const GAS_URL = "https://script.google.com/macros/s/AKfycbzsyQHWcDnWTiPNpajpo8FxRDkv9J1jNfQBtkw_e_S0bMLtYrqwlqwzUaYwPKVLgqU/exec";

        let state = {
            user: JSON.parse(localStorage.getItem('edupro_student')) || null,
            currentView: localStorage.getItem('edupro_student') ? 'dashboard' : 'catalog', 
            activeCourse: null,
            activeTab: 'materi',
            courses: []
        };

        const apiCall = async (action, payload = {}) => {
            try {
                const response = await fetch(GAS_URL, { method: 'POST', headers: { 'Content-Type': 'text/plain;charset=utf-8' }, body: JSON.stringify({ action, payload }) });
                return await response.json();
            } catch (error) { return { success: false, error: "Koneksi ke server gagal." }; }
        };

        const showToast = (message, icon = 'success') => Swal.fire({ toast: true, position: 'top-end', icon, title: message, showConfirmButton: false, timer: 3000 });
        const formatRupiah = (angka) => new Intl.NumberFormat('id-ID').format(angka);

        const renderApp = () => {
            const app = document.getElementById('app');
            let html = `
                <nav class="navbar navbar-expand-lg sticky-top">
                    <div class="container">
                        <a class="navbar-brand d-flex align-items-center gap-2" href="#" onclick="navigate(${state.user ? "'dashboard'" : "'catalog'"})">
                            <i class="fa-solid fa-graduation-cap"></i> EduPro
                        </a>
                        <div class="d-flex align-items-center gap-3">
            `;

            if (state.user) {
                html += `
                            <div class="text-end d-none d-sm-block"><div class="fw-bold text-dark lh-1">${state.user.full_name}</div><small class="text-muted text-capitalize">Siswa</small></div>
                            <button onclick="handleLogout()" class="btn btn-outline-danger btn-sm"><i class="fa-solid fa-right-from-bracket"></i> Keluar</button>
                `;
            } else {
                html += `
                            <button onclick="navigate('login')" class="btn btn-outline-primary btn-sm fw-bold">Masuk</button>
                            <button onclick="navigate('register')" class="btn btn-primary btn-sm fw-bold">Daftar</button>
                `;
            }

            html += `
                        </div>
                    </div>
                </nav>
                <main class="container py-4 flex-grow-1" id="main-content"></main>
            `;
            
            app.innerHTML = html;

            const mainContent = document.getElementById('main-content');
            if (state.currentView === 'catalog') renderPublicCatalog(mainContent);
            else if (state.currentView === 'login') renderLogin(mainContent);
            else if (state.currentView === 'register') renderRegister(mainContent);
            else if (state.currentView === 'dashboard') renderDashboard(mainContent);
            else if (state.currentView === 'courseDetail') renderCourseDetail(mainContent);
        };

        const navigate = (view, courseData = null) => {
            state.currentView = view;
            if (courseData) {
                state.activeCourse = courseData;
                state.activeTab = 'materi';
            }
            if (view === 'dashboard' || view === 'catalog') state.activeCourse = null;
            renderApp();
        };

        const renderPublicCatalog = async (container) => {
            container.innerHTML = `
                <div class="text-center mb-5 mt-4">
                    <span class="badge bg-primary bg-opacity-10 text-primary px-3 py-2 rounded-pill mb-3 fw-bold">Tempat Belajar Terbaik</span>
                    <h1 class="fw-bold text-dark mb-3">Tingkatkan Keahlian Anda Hari Ini</h1>
                    <p class="text-muted" style="max-width: 600px; margin: 0 auto;">Pilih dari berbagai katalog kelas interaktif kami. Daftar sekarang untuk mulai belajar dan dapatkan sertifikat kelulusan.</p>
                </div>
                <div id="publicCourseList" class="row g-4"><div class="loader-container"><div class="spinner-border text-primary"></div></div></div>
            `;

            const resCourses = await apiCall('getCourses', {});
            const listContainer = document.getElementById('publicCourseList');
            state.courses = resCourses.data || [];

            if (state.courses.length === 0) return listContainer.innerHTML = `<div class="col-12 text-center text-muted p-5 bg-white rounded">Belum ada kelas tersedia.</div>`;

            let html = '';
            state.courses.forEach(course => {
                const price = parseInt(course.price) || 0;
                const isFree = price === 0;
                let badgeHtml = isFree ? `<span class="price-badge bg-success text-white">Gratis</span>` : `<span class="price-badge bg-warning text-dark"><i class="fa-solid fa-tag me-1"></i>Rp ${formatRupiah(price)}</span>`;

                html += `
                    <div class="col-12 col-md-6 col-lg-4">
                        <div class="card card-hover h-100 border-0" onclick="handleGuestClick()" style="cursor: pointer;">
                            ${badgeHtml}
                            <div class="bg-primary bg-opacity-10 p-4 rounded-top text-center" style="height: 120px; display: flex; align-items: center; justify-content: center;">
                                <i class="fa-solid fa-book-open-reader text-primary fa-3x"></i>
                            </div>
                            <div class="card-body d-flex flex-column">
                                <h5 class="card-title fw-bold">${course.title}</h5>
                                <p class="card-text text-muted small line-clamp-2 flex-grow-1">${course.description}</p>
                                <button class="btn btn-primary w-100 mt-3">Daftar Kelas Ini</button>
                            </div>
                        </div>
                    </div>`;
            });
            listContainer.innerHTML = html;
        };

        window.handleGuestClick = () => {
            Swal.fire({
                title: 'Akses Dibatasi',
                text: 'Silakan Login atau Daftar akun terlebih dahulu untuk mengakses kelas ini.',
                icon: 'info',
                showCancelButton: true, confirmButtonText: 'Login', cancelButtonText: 'Daftar Baru', confirmButtonColor: '#4f46e5', cancelButtonColor: '#10b981'
            }).then((result) => {
                if (result.isConfirmed) navigate('login');
                else if (result.dismiss === Swal.DismissReason.cancel) navigate('register');
            });
        };

        const renderLogin = (container) => {
            container.innerHTML = `
                <div class="row justify-content-center align-items-center h-100 mt-5">
                    <div class="col-12 col-md-6 col-lg-5">
                        <div class="card p-4 p-md-5 text-center shadow-sm">
                            <h2 class="fw-bold mb-1 text-primary">Selamat Datang</h2><p class="text-muted mb-4">Masuk ke ruang belajar Anda</p>
                            <form id="loginForm">
                                <div class="mb-3 text-start"><label class="form-label fw-semibold small">NISN / Username</label><input type="text" id="nisn" class="form-control" placeholder="Masukkan NISN..." required></div>
                                <div class="mb-4 text-start"><label class="form-label fw-semibold small">Password</label><input type="password" id="password" class="form-control" placeholder="Masukkan Password..." required></div>
                                <button type="submit" class="btn btn-primary w-100 py-2 mb-3" id="btnLogin"><i class="fa-solid fa-arrow-right-to-bracket me-2"></i> Masuk Sekarang</button>
                                <p class="text-muted small">Belum punya akun? <a href="#" onclick="navigate('register')" class="text-primary fw-bold text-decoration-none">Daftar di sini</a></p>
                            </form>
                        </div>
                    </div>
                </div>`;

            document.getElementById('loginForm').addEventListener('submit', async (e) => {
                e.preventDefault();
                const btn = document.getElementById('btnLogin'); btn.innerHTML = 'Memeriksa...'; btn.disabled = true;
                const res = await apiCall('login', { nisn: document.getElementById('nisn').value, password: document.getElementById('password').value });
                
                if (res.success) {
                    if(res.data.role !== 'student') { Swal.fire('Akses Ditolak', 'Halaman ini khusus Siswa.', 'warning'); btn.innerHTML = 'Masuk Sekarang'; btn.disabled = false; return; }
                    state.user = res.data; localStorage.setItem('edupro_student', JSON.stringify(res.data));
                    showToast(`Halo, ${res.data.full_name}!`); navigate('dashboard');
                } else { Swal.fire('Gagal', res.error, 'error'); btn.innerHTML = 'Masuk Sekarang'; btn.disabled = false; }
            });
        };

        const renderRegister = (container) => {
            container.innerHTML = `
                <div class="row justify-content-center align-items-center h-100 mt-4">
                    <div class="col-12 col-md-6 col-lg-5">
                        <div class="card p-4 p-md-5 shadow-sm border-top border-4 border-primary">
                            <h3 class="fw-bold mb-1 text-center">Buat Akun Baru</h3><p class="text-muted mb-4 text-center small">Mulai perjalanan belajar Anda</p>
                            <form id="registerForm">
                                <div class="mb-3"><label class="form-label fw-semibold small">Nama Lengkap</label><input type="text" id="regName" class="form-control" placeholder="Cth: Budi Santoso" required></div>
                                <div class="mb-3"><label class="form-label fw-semibold small">NISN / Username</label><input type="text" id="regNisn" class="form-control" placeholder="Cth: 12345678" required></div>
                                <div class="mb-4"><label class="form-label fw-semibold small">Buat Password</label><input type="password" id="regPassword" class="form-control" placeholder="Minimal 6 karakter" required minlength="6"></div>
                                <button type="submit" class="btn btn-success w-100 py-2 mb-3" id="btnRegister"><i class="fa-solid fa-user-plus me-2"></i> Daftar Sekarang</button>
                                <p class="text-center text-muted small mb-0">Sudah punya akun? <a href="#" onclick="navigate('login')" class="text-primary fw-bold text-decoration-none">Login di sini</a></p>
                            </form>
                        </div>
                    </div>
                </div>`;

            document.getElementById('registerForm').addEventListener('submit', async (e) => {
                e.preventDefault();
                const btn = document.getElementById('btnRegister'); btn.innerHTML = 'Memproses...'; btn.disabled = true;
                const payload = { full_name: document.getElementById('regName').value, nisn: document.getElementById('regNisn').value, password: document.getElementById('regPassword').value };
                
                const res = await apiCall('register', payload);
                if (res.success) { Swal.fire({ icon: 'success', title: 'Berhasil!', text: res.message, confirmButtonColor: '#4f46e5' }).then(() => navigate('login')); } 
                else { Swal.fire('Gagal', res.error, 'error'); btn.innerHTML = 'Daftar Sekarang'; btn.disabled = false; }
            });
        };

        const handleLogout = () => {
            Swal.fire({ title: 'Keluar?', text: "Sesi akan diakhiri.", icon: 'warning', showCancelButton: true, confirmButtonColor: '#d33', confirmButtonText: 'Keluar' }).then((res) => {
                if (res.isConfirmed) { localStorage.removeItem('edupro_student'); state.user = null; navigate('catalog'); }
            });
        };

        const renderDashboard = async (container) => {
            container.innerHTML = `
                <div class="card text-white p-4 p-md-5 mb-4 rounded-4 shadow-sm" style="background: linear-gradient(135deg, var(--primary-color), #8b5cf6);">
                    <h2 class="fw-bold">Halo, ${state.user.full_name}! ðŸ‘‹</h2><p class="mb-0 opacity-75">Selamat datang di ruang belajar Anda.</p>
                </div>
                <h4 class="fw-bold mb-3">Katalog Kelas Pembelajaran</h4>
                <div id="courseList" class="row g-4"><div class="loader-container"><div class="spinner-border text-primary"></div></div></div>`;
            
            const [resCourses, resTrx] = await Promise.all([ apiCall('getCourses', {}), apiCall('getTransactions', { student_id: state.user.id }) ]);
            const listContainer = document.getElementById('courseList');
            state.courses = resCourses.data || [];
            const transactions = resTrx.success ? resTrx.data : [];

            if (state.courses.length === 0) return listContainer.innerHTML = `<div class="col-12 text-center text-muted p-5 bg-white rounded">Belum ada kelas tersedia.</div>`;

            let html = '';
            state.courses.forEach(course => {
                const price = parseInt(course.price) || 0;
                const isFree = price === 0;
                const isOwned = transactions.some(t => t.course_id === course.id && t.status === 'PAID');
                const hasAccess = isFree || isOwned;

                let badgeHtml = isFree ? `<span class="price-badge bg-success text-white">Gratis</span>` : `<span class="price-badge bg-warning text-dark"><i class="fa-solid fa-tag me-1"></i>Rp ${formatRupiah(price)}</span>`;
                if (isOwned && !isFree) badgeHtml = `<span class="price-badge bg-primary text-white"><i class="fa-solid fa-circle-check me-1"></i>Dibeli</span>`;

                html += `
                    <div class="col-12 col-md-6 col-lg-4">
                        <div class="card card-hover h-100 border-0" onclick="openStudentCourseGlobal('${course.id}', ${hasAccess})" style="cursor: pointer;">
                            ${badgeHtml}
                            <div class="bg-primary bg-opacity-10 p-4 rounded-top text-center" style="height: 120px; display: flex; align-items: center; justify-content: center;">
                                <i class="fa-solid ${hasAccess ? 'fa-book-open-reader text-primary' : 'fa-lock text-danger'} fa-3x"></i>
                            </div>
                            <div class="card-body d-flex flex-column">
                                <h5 class="card-title fw-bold">${course.title}</h5>
                                <p class="card-text text-muted small line-clamp-2 flex-grow-1">${course.description}</p>
                                ${hasAccess ? `<div class="mt-3 text-primary fw-bold small">Mulai Belajar <i class="fa-solid fa-arrow-right ms-1"></i></div>` : `<button class="btn btn-danger w-100 mt-3"><i class="fa-solid fa-cart-shopping me-2"></i> Beli Akses</button>`}
                            </div>
                        </div>
                    </div>`;
            });
            listContainer.innerHTML = html;
        };

        window.openStudentCourseGlobal = (id, hasAccess) => {
            const course = state.courses.find(c => c.id === id);
            if (course) hasAccess ? navigate('courseDetail', course) : window.handleCheckout(id);
        };

        window.handleCheckout = (courseId) => {
            const course = state.courses.find(c => c.id === courseId);
            Swal.fire({
                title: 'Buka Akses Kelas?', html: `Anda perlu membeli kelas <b>${course.title}</b> seharga <b>Rp ${formatRupiah(course.price)}</b>.`, icon: 'info',
                showCancelButton: true, confirmButtonColor: '#4f46e5', confirmButtonText: '<i class="fa-solid fa-cart-shopping me-1"></i> Lanjut Bayar', cancelButtonText: 'Batal'
            }).then(async (result) => {
                if (result.isConfirmed) {
                    Swal.fire({ title: 'Membuat Tagihan...', allowOutsideClick: false, didOpen: () => { Swal.showLoading(); }});
                    const res = await apiCall('createTransaction', { student_id: state.user.id, course_id: course.id });
                    
                    if (res.success) {
                        Swal.fire({
                            title: 'Pembayaran Akses Premium',
                            html: `<div class="text-center mt-3"><p class="text-muted small mb-3">Selesaikan pembayaran untuk <b>${course.title}</b></p>
                                    <div class="qris-box shadow-sm"><img src="https://i.ibb.co.com/4wQBptFN/Qris-Dana-fix.png" alt="QRIS DANA" class="img-fluid rounded" style="width: 180px; height: 180px;"></div>
                                    <h3 class="fw-bold text-primary mt-2">Rp ${formatRupiah(course.price)}</h3>
                                    <div class="bg-light p-3 rounded text-start mt-3 border"><p class="small fw-bold mb-1"><i class="fa-solid fa-circle-info text-info me-1"></i> Cara Membayar:</p>
                                    <ol class="small text-muted mb-0 ps-3"><li>Buka aplikasi DANA/GoPay/M-Banking.</li><li>Scan kode QR di atas.</li><li>Simpan bukti transfer.</li><li>Kirimkan bukti transfer di Wa : 0819-9979-3085</li></ol></div>
                                    <p class="small text-muted mt-3 mb-0">No. Tagihan: ${res.data.id}</p></div>`,
                            showCancelButton: true, confirmButtonColor: '#10b981', confirmButtonText: '<i class="fa-solid fa-check me-1"></i> Saya Sudah Bayar', cancelButtonText: 'Tutup', customClass: { htmlContainer: 'text-center' }
                        }).then((payResult) => {
                            if (payResult.isConfirmed) { Swal.fire('Menunggu Verifikasi', 'Pembayaran diproses. Akses kelas terbuka setelah diverifikasi Admin.', 'success').then(() => renderDashboard(document.getElementById('main-content'))); }
                        });
                    } else Swal.fire('Gagal', res.error, 'error');
                }
            });
        };

        const renderCourseDetail = async (container) => {
            container.innerHTML = `
                <button onclick="navigate('dashboard')" class="btn btn-link text-decoration-none text-muted p-0 mb-4 fw-semibold"><i class="fa-solid fa-arrow-left me-1"></i> Kembali ke Katalog</button>
                <div class="card bg-dark text-white p-4 p-md-5 mb-4 rounded-4" style="background: linear-gradient(to right, #0f172a, #334155) !important;">
                    <div class="d-flex justify-content-between align-items-center flex-wrap gap-3">
                        <div>
                            <h2 class="fw-bold">${state.activeCourse.title}</h2>
                            <p class="mb-0 text-white-50">${state.activeCourse.description}</p>
                        </div>
                        <div id="certificateContainer"></div>
                    </div>
                </div>
                
                <ul class="nav nav-tabs mb-4">
                    <li class="nav-item"><button class="nav-link ${state.activeTab === 'materi' ? 'active' : ''}" onclick="switchTab('materi')"><i class="fa-solid fa-book me-2"></i>Materi Belajar</button></li>
                    <li class="nav-item"><button class="nav-link ${state.activeTab === 'kuis' ? 'active' : ''}" onclick="switchTab('kuis')"><i class="fa-solid fa-list-check me-2"></i>Ujian Kuis</button></li>
                </ul>

                <div id="tabContent"><div class="loader-container"><div class="spinner-border text-primary"></div></div></div>`;
            
            loadTabContent();
        };

        window.switchTab = (tabName) => { state.activeTab = tabName; renderCourseDetail(document.getElementById('main-content')); };

        const loadTabContent = async () => {
            const content = document.getElementById('tabContent');
            const certArea = document.getElementById('certificateContainer');

            const [resMat, resProg, resScore, resQuiz, resSub] = await Promise.all([
                apiCall('getMaterials', { course_id: state.activeCourse.id }),
                apiCall('getProgress', { student_id: state.user.id }),
                apiCall('getQuizScore', { student_id: state.user.id, course_id: state.activeCourse.id }),
                apiCall('getQuiz', { course_id: state.activeCourse.id, role: 'student' }),
                apiCall('getSubmissions', { course_id: state.activeCourse.id }) 
            ]);

            const materials = resMat.data || [];
            const progressMap = resProg.success ? resProg.data.map(p => p.material_id) : [];
            const bestScore = resScore.data ? resScore.data.score : null;
            const isPassedQuiz = resScore.data ? resScore.data.passed : false;
            const quizzes = resQuiz.data || [];
            
            const mySubmissions = resSub.success ? resSub.data.filter(s => s.student_id === state.user.id) : [];
            
            const totalMateri = materials.length;
            const materiSelesai = progressMap.length;
            const persentase = totalMateri === 0 ? 0 : Math.round((materiSelesai / totalMateri) * 100);
            
            let quizScore = quizzes.length > 0 ? (bestScore || 0) : null;
            let assignmentScores = mySubmissions.filter(s => s.score !== '' && s.score !== null).map(s => parseFloat(s.score));
            let avgAssignmentScore = assignmentScores.length > 0 ? (assignmentScores.reduce((a,b) => a+b, 0) / assignmentScores.length) : null;

            let finalScore = 0;
            if (quizScore !== null && avgAssignmentScore !== null) { finalScore = (quizScore + avgAssignmentScore) / 2; } 
            else if (quizScore !== null) { finalScore = quizScore; } 
            else if (avgAssignmentScore !== null) { finalScore = avgAssignmentScore; } 
            else { finalScore = 100; }

            finalScore = Math.round(finalScore);

            let predikat = "LULUS";
            if (finalScore >= 93) { predikat = "SANGAT BAIK"; } 
            else if (finalScore >= 80) { predikat = "BAIK"; }

            window.courseFinalScore = finalScore;
            window.coursePredikat = predikat;

            const isPaidCourse = parseInt(state.activeCourse.price) > 0;
            const isLulus = (persentase === 100 && totalMateri > 0) && (quizzes.length === 0 || isPassedQuiz);

            if (isLulus && isPaidCourse) {
                certArea.innerHTML = `<button onclick="downloadCertificate()" class="btn btn-success certificate-btn px-4 py-2 rounded-pill shadow"><i class="fa-solid fa-award me-2"></i> Unduh Sertifikat</button>`;
                if(!window.hasSeenCongrats) { Swal.fire('Luar Biasa!', `Anda telah lulus dari kelas ini dengan Predikat ${predikat} (${finalScore}/100)!`, 'success'); window.hasSeenCongrats = true; }
            } else { certArea.innerHTML = ''; }

            // =====================================
            // TAB MATERI
            // =====================================
            if (state.activeTab === 'materi') {
                let html = ``;
                if (totalMateri > 0) {
                    html += `
                        <div class="mb-4">
                            <div class="d-flex justify-content-between align-items-center mb-1">
                                <span class="small fw-bold text-muted">Progress Belajar Anda:</span>
                                <span class="small fw-bold text-primary">${persentase}% Selesai</span>
                            </div>
                            <div class="progress shadow-sm"><div class="progress-bar ${persentase === 100 ? 'bg-success' : 'bg-primary'}" style="width: ${persentase}%"></div></div>
                        </div>`;
                }

                html += `<div class="d-flex flex-column gap-3">`;
                if (materials.length === 0) { html += `<div class="text-center text-muted p-5 bg-white rounded border">Belum ada materi pembelajaran.</div>`; } 
                else {
                    materials.forEach((mat, idx) => {
                        const isDone = progressMap.includes(mat.id);
                        let embedPreview = mat.embed_code ? `<div class="mt-4 ratio ratio-16x9 bg-dark rounded overflow-hidden shadow-sm">${mat.embed_code}</div>` : '';
                        
                        let taskHtml = '';
                        if (mat.content_url) { 
                            const existingSub = mySubmissions.find(s => s.material_id === mat.id);
                            const subUrl = existingSub ? existingSub.submission_url : '';
                            const scoreBadge = (existingSub && existingSub.score !== '' && existingSub.score !== null) 
                                ? `<span class="badge bg-success ms-2 rounded-pill">Nilai: ${existingSub.score}</span>` 
                                : (existingSub ? `<span class="badge bg-secondary ms-2 rounded-pill">Menunggu Penilaian</span>` : '');
                                
                            const btnText = existingSub ? '<i class="fa-solid fa-upload"></i> Upload Ulang Tugas' : '<i class="fa-solid fa-upload"></i> Upload Tugas';
                            const btnClass = existingSub ? 'btn-outline-warning' : 'btn-warning';

                            taskHtml = `
                                <div class="mt-3 p-3 bg-warning bg-opacity-10 border border-warning border-opacity-50 rounded-3">
                                    <p class="small fw-bold text-dark mb-1"><i class="fa-solid fa-file-signature text-warning me-1"></i> Instruksi Tugas:</p>
                                    <p class="small text-muted mb-3">${mat.content_url}</p>
                                    <div class="d-flex flex-column flex-sm-row gap-2">
                                        <input type="file" id="task_file_${mat.id}" class="form-control form-control-sm border-warning" accept="image/*,application/pdf" title="Pilih foto/PDF hasil kerjaan Anda">
                                        <button onclick="submitTask('${mat.id}')" class="btn ${btnClass} btn-sm fw-bold text-nowrap">${btnText}</button>
                                    </div>
                                    <small class="text-muted d-block mt-2">*Gunakan format foto (JPG/PNG) atau PDF. Maksimal 5MB.</small>
                                    ${existingSub ? `<div class="mt-2 small text-success fw-semibold"><i class="fa-solid fa-check-circle"></i> Tugas berhasil diupload ke server. ${scoreBadge}<br><a href="${subUrl}" target="_blank" class="small text-primary mt-1 d-inline-block"><i class="fa-solid fa-up-right-from-square"></i> Lihat file tugas yang dikirim</a></div>` : ''}
                                </div>
                            `;
                        }

                        html += `
                            <div class="card ${isDone ? 'border-success' : ''}">
                                <div class="card-body">
                                    <div class="d-flex flex-column flex-md-row gap-3">
                                        <div class="bg-primary bg-opacity-10 text-primary fw-bold rounded-circle d-flex align-items-center justify-content-center flex-shrink-0" style="width: 50px; height: 50px; font-size: 1.2rem;">${mat.order_number || idx + 1}</div>
                                        <div class="flex-grow-1">
                                            <h5 class="fw-bold mb-1">${mat.title}</h5>
                                            <p class="text-muted small mb-0">${mat.description}</p>
                                            ${taskHtml}
                                        </div>
                                        <div class="d-flex gap-2 w-100 w-md-auto mt-3 mt-md-0 align-items-start justify-content-end">
                                            ${isDone ? `<span class="btn btn-success disabled"><i class="fa-solid fa-check"></i> Selesai</span>` : `<button onclick="markDone('${mat.id}')" class="btn btn-success">Tandai Selesai</button>`}
                                        </div>
                                    </div>
                                    ${embedPreview}
                                </div>
                            </div>`;
                    });
                }
                html += `</div>`;
                content.innerHTML = html;
            } 
            // =====================================
            // TAB KUIS (DENGAN SOAL ACAK)
            // =====================================
            else if (state.activeTab === 'kuis') {
                if (persentase < 100) {
                    content.innerHTML = `<div class="alert alert-warning text-center p-5 border border-warning rounded-4 shadow-sm"><i class="fa-solid fa-lock fa-3x mb-3 text-warning opacity-75 d-block"></i><h4 class="fw-bold">Ujian Masih Terkunci</h4><p class="mb-0">Anda harus menyelesaikan seluruh materi terlebih dahulu untuk dapat mengikuti Ujian Kuis ini.</p></div>`; return;
                }
                if (quizzes.length === 0) {
                    content.innerHTML = `<div class="text-center text-muted p-5 bg-white rounded border">Guru belum membuat soal kuis untuk kelas ini. Anda otomatis lulus!</div>`; return;
                }

                // FITUR ACAK SOAL
                let randomizedQuizzes = [...quizzes].sort(() => Math.random() - 0.5);

                let html = '';
                if (bestScore !== null) {
                    html += `
                        <div class="alert ${isPassedQuiz ? 'alert-success border-success' : 'alert-danger border-danger'} text-center mb-4 rounded-4 shadow-sm">
                            <p class="mb-1 text-muted fw-semibold">Nilai Ujian Terbaik Anda</p>
                            <h2 class="fw-bold mb-2 ${isPassedQuiz ? 'text-success' : 'text-danger'}">${bestScore} <small style="font-size: 1rem;">/ 100</small></h2>
                            <p class="mb-0 small">${isPassedQuiz ? '<i class="fa-solid fa-circle-check"></i> Selamat! Anda lulus KKM (80).' : '<i class="fa-solid fa-circle-xmark"></i> Nilai di bawah KKM. Silakan coba mengulang kuis di bawah ini.'}</p>
                        </div>`;
                }

                html += `<form id="quizForm" class="d-flex flex-column gap-3">`;
                randomizedQuizzes.forEach((q, idx) => {
                    html += `
                        <div class="card shadow-sm border-0">
                            <div class="card-body p-4">
                                <h6 class="fw-bold mb-3 lh-base"><span class="text-primary me-1">${idx + 1}.</span> ${q.question}</h6>
                                <div class="form-check mb-2 bg-light p-3 rounded border"><input class="form-check-input ms-1 me-2" type="radio" name="q_${q.id}" id="a_${q.id}" value="a" required><label class="form-check-label w-100" style="cursor: pointer;" for="a_${q.id}">A. ${q.a}</label></div>
                                <div class="form-check mb-2 bg-light p-3 rounded border"><input class="form-check-input ms-1 me-2" type="radio" name="q_${q.id}" id="b_${q.id}" value="b" required><label class="form-check-label w-100" style="cursor: pointer;" for="b_${q.id}">B. ${q.b}</label></div>
                                <div class="form-check mb-2 bg-light p-3 rounded border"><input class="form-check-input ms-1 me-2" type="radio" name="q_${q.id}" id="c_${q.id}" value="c" required><label class="form-check-label w-100" style="cursor: pointer;" for="c_${q.id}">C. ${q.c}</label></div>
                                <div class="form-check mb-2 bg-light p-3 rounded border"><input class="form-check-input ms-1 me-2" type="radio" name="q_${q.id}" id="d_${q.id}" value="d" required><label class="form-check-label w-100" style="cursor: pointer;" for="d_${q.id}">D. ${q.d}</label></div>
                            </div>
                        </div>`;
                });
                html += `<button type="submit" id="btnSubmitQuiz" class="btn btn-primary btn-lg mt-3 w-100 py-3 rounded-3 shadow-sm"><i class="fa-solid fa-paper-plane me-2"></i> Kumpulkan Jawaban Ujian</button></form>`;
                
                content.innerHTML = html;

                document.getElementById('quizForm').addEventListener('submit', async (e) => {
                    e.preventDefault();
                    Swal.fire({ title: 'Menghitung Nilai...', text: 'Mohon tunggu sebentar', allowOutsideClick: false, didOpen: () => { Swal.showLoading(); }});
                    
                    const answers = {};
                    quizzes.forEach(q => { const selected = document.querySelector(`input[name="q_${q.id}"]:checked`); if(selected) answers[q.id] = selected.value; });

                    const res = await apiCall('submitQuiz', { student_id: state.user.id, course_id: state.activeCourse.id, answers: answers });
                    if(res.success) { Swal.fire({ icon: res.data.passed ? 'success' : 'error', title: `Skor Anda: ${res.data.score}`, text: res.message, confirmButtonColor: '#4f46e5' }).then(() => loadTabContent()); } 
                    else { Swal.fire('Error', res.error, 'error'); }
                });
            }
        };

        window.markDone = async (materialId) => {
            const res = await apiCall('markProgress', { student_id: state.user.id, material_id: materialId });
            if(res.success) { showToast(res.message); renderCourseDetail(document.getElementById('main-content')); }
        };

        window.submitTask = async (materialId) => {
            const fileInput = document.getElementById(`task_file_${materialId}`);
            if (!fileInput.files || fileInput.files.length === 0) { return Swal.fire('Oops!', 'Mohon pilih file foto/dokumen tugas Anda terlebih dahulu.', 'warning'); }
            
            const file = fileInput.files[0];
            if (file.size > 5 * 1024 * 1024) { return Swal.fire('Oops!', 'Ukuran file terlalu besar. Maksimal 5MB.', 'warning'); }

            Swal.fire({ title: 'Mengupload Tugas...', text: 'Mohon tunggu, foto sedang disimpan ke Google Drive...', allowOutsideClick: false, didOpen: () => { Swal.showLoading(); }});
            
            const reader = new FileReader();
            reader.onload = async function(e) {
                const result = e.target.result; 
                const base64Data = result.split(',')[1];
                
                const payload = { student_id: state.user.id, course_id: state.activeCourse.id, material_id: materialId, fileName: file.name, mimeType: file.type, fileData: base64Data };
                const res = await apiCall('submitAssignment', payload);
                if (res.success) { showToast(res.message); loadTabContent(); } 
                else { Swal.fire('Gagal', res.error, 'error'); }
            };
            reader.onerror = function() { Swal.fire('Gagal', 'Terjadi kesalahan saat membaca file.', 'error'); };
            reader.readAsDataURL(file); 
        };

        // =====================================
        // MEMANGGIL API CETAK SERTIFIKAT KE SERVER
        // =====================================
        window.downloadCertificate = async () => {
            Swal.fire({ 
                title: 'Mencetak Sertifikat...', 
                text: 'Sistem sedang memproses dokumen resmi Anda di server. Mohon tunggu sekitar 5-10 detik...', 
                allowOutsideClick: false, 
                didOpen: () => { Swal.showLoading(); }
            });

            // Mengirim perintah cetak ke server code.gs
            const payload = {
                student_id: state.user.id,
                course_id: state.activeCourse.id,
                final_score: window.courseFinalScore,
                predikat: window.coursePredikat
            };

            const res = await apiCall('generateCertificate', payload);

            if (res.success) {
                Swal.fire({
                    title: 'Berhasil!',
                    text: 'Sertifikat Anda telah siap diunduh.',
                    icon: 'success',
                    confirmButtonText: '<i class="fa-solid fa-download"></i> Lihat Dokumen'
                }).then(() => {
                    // Sistem akan langsung membuka file PDF yang tersimpan di Google Drive
                    window.open(res.link, '_blank');
                });
            } else {
                Swal.fire('Gagal', res.error, 'error');
            }
        };

        renderApp();
    </script>
</body>
</html>
